Apply this patch to OpenSSH 9.5p1 and build as normal.
This will make ssh-store as well as special versions of ssh-agent, scp, and sftp
(these scp and sftp don't disable agent forwarding and don't use the new
PermitLocalCommand option that is not supported by older versions of the ssh
client - useful if scp/sftp use the system default ssh).

Add make SSH_PROGRAM=ssh to get scp and sftp to use ssh from the PATH,
rather than the hard-coded /usr/local/bin/ssh.

Alma9 build from openssh-portable git repo
==========================================

  git clone https://github.com/openssh/openssh-portable.git
  cd openssh-portable
  git checkout V_8_7_P1
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/ssh-store7-alma9.patch
  patch < ssh-store7-alma9.patch
  sudo dnf install openssl-devel zlib-devel pam-devel
  autoreconf
  ./configure
  make -j4

Alma9 (and RHEL9) doesn't provide statically linked OpenSSL libraries, as CentOS7 did.

Alma9 build from source rpm
===========================

  sudo dnf groupinstall "Development Tools"
  sudo dnf install rpm-build rpmdevtools dnf-plugins-core
  sudo dnf config-manager --set-enabled crb  # Enable the CRB (CodeReady Builder) repository, which gives us libfido2-devel
  sudo dnf download --source openssh
  sudo dnf builddep openssh

  rpmdev-setuptree
  rpm -ivh openssh-8.7p1-47.el9_7.alma.1.src.rpm
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/ssh-store7-alma9-rpm.patch
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/openssh-8.7p1-47.el9_7.alma.1-store7.spec.patch
  cp ssh-store7-alma9-rpm.patch ~/rpmbuild/SOURCES/
  (cd; patch -p0) < openssh-8.7p1-47.el9_7.alma.1-store7.spec.patch

  rpmbuild -ba ~/rpmbuild/SPECS/openssh.spec

CentOS7 build
=============

  yum install openssl-static
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/ssh-store6-c7.patch
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/openssh-7.4p1-6-x86_64-centos7-store.spec.patch
  cp ssh-store6-c7.patch SOURCES/
  patch < openssh-7.4p1-6-x86_64-centos7-store.spec.patch
  rpmbuild -ba --define "static_openssl 1" SPECS/openssh.spec

This builds with static SSL libraries, which should help ssh work with later OS versions (eg. Alma9).

Other Linux
===========

  LIBS="-Wl,-Bstatic -lcrypto -Wl,-Bdynamic -lutil -lcrypt -lresolv -ldl -lz" ./configure
  make install DESTDIR=$PWD/bin

This makes executables with static SSL libraries (libcrypto, in openssl-static rpm).
Can also use 'make LIBS=...' or whatever configure lists as libraries (last line of summary) with
-Wl,-Bstatic before the -lcrypto and -Wl,-Bdynamic after. Note that this only works for libcrypto
(the other libraries need to be compiled with -fPIC), but that's OK as it is the
only one that changes between CentOS7 and Alma9.

Cygwin build
============

1. Use setup.exe to install openssh src files and build pre-requisites (requires Administrator mode, unless -B is used):
  /setup-x86_64.exe -q -P cygport,autoconf,automake,gcc-g++,make,libcrypt-devel,libedit-devel,libfido2-devel,libkrb5-devel,libssl-devel,zlib-devel
  /setup-x86_64.exe -q -I -P openssh
2.
  cd /usr/src/openssh-10.2p1-1.src
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/cygwin/ssh-store7-cygwin.patch
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/cygwin/openssh-10.2p1-1-x86_64-store7.cygport.patch
  patch < openssh-10.2p1-1-x86_64-store7.cygport.patch
  mkdir patches
  mv ssh-store7-cygwin.patch patches/
  cygport openssh.cygport all

Windows build
=============

The Windows ssh-agent sources are in contrib/win32/win32compat/ssh-agent.
Keys and variables are stored in HKEY_CURRENT_USER\Software\OpenSSH, so they are
persistent and specific for each user connecting with ssh-add/ssh-store.

1.
  git clone https://github.com/PowerShell/openssh-portable.git
  cd openssh-portable
  git checkout v9.5.0.0
  wget --no-check-certificate https://hepunx.rl.ac.uk/~adye/software/ssh-store7-win32.patch
  patch < ssh-store7-win32.patch
2. Start Visual Studio 2022
3. Open contrib\win32\openssh\Win32-OpenSSH.sln
4. Switch to Release build
5. Build Solution
6. install:
  cd bin\x64\Release
  copy *.exe C:\Apps\OpenSSH
  copy *.txt C:\Apps\OpenSSH
7. configure custom ssh-agent service from an Administrator Command Prompt:
  sc create ssh-agent-store binPath= "C:\Apps\OpenSSH\ssh-agent.exe" DisplayName= "OpenSSH Authentication Agent store"
  sc description ssh-agent-store "Agent to hold private keys used for public key authentication. This version also supports ssh-store."
  sc config ssh-agent-store start= auto
  sc start ssh-agent-store
8. To use Windows ssh-agent from Cygwin or WSL: install socat and https://github.com/albertony/npiperelay . Start with:
  export SSH_AUTH_SOCK=/tmp/ssh-agent.$UID.sock
  umask 077
  setsid socat UNIX-LISTEN:"$SSH_AUTH_SOCK",fork EXEC:"npiperelay.exe -ei -s //./pipe/openssh-ssh-agent",nofork &

==============================================================================

The following are instructions for compiling with OpenSSH 5.2p1 with a previous version of this patch...

I built openssh-5.2p1-store-i386_linux24.tar.bz2 on yakut02 (Scientific Linux 3.0.9) with:

cd /usr/work/adye
wget http://hepunx.rl.ac.uk/~adye/software/ssh-store4.patch
wget -N ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-5.2p1.tar.gz
tar zxf openssh-5.2p1.tar.gz
cd openssh-5.2p1
patch -Zp1 < ../ssh-store4.patch
./configure
make install DESTDIR=/usr/work/adye/openssh-5.2p1-bin LIBS="-Wl,-Bstatic -lcrypto -lutil -lz -lnsl -lcrypt -lresolv -Wl,-Bdynamic" SSH_PROGRAM=ssh
cd /usr/work/adye/openssh-5.2p1-bin
find * \! -type d | tar cvjfT ../openssh-5.2p1-store-i386_linux24.tar.bz2 -

I built openssh-5.2p1-store-sun4x_510.tar.bz2 on tersk01 (SunOS 5.10) with:

wget http://hepunx.rl.ac.uk/~adye/software/ssh-store4.patch
wget -N ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-5.2p1.tar.gz
gunzip openssh-5.2p1.tar.gz
tar xf openssh-5.2p1.tar
cd openssh-5.2p1
patch -p1 < ../ssh-store4.patch
./configure
make install DESTDIR=/usr/work/adye/openssh-5.2p1-bin SSH_PROGRAM=ssh
cd /usr/work/adye/openssh-5.2p1-bin
tar cf ../openssh-5.2p1-store-sun4x_510.tar `find * \! -type d`
bzip2 ../openssh-5.2p1-store-sun4x_510.tar

==============================================================================
diff --git a/authfd.c b/authfd.c
index 25a363664..c697c7135 100644
--- a/authfd.c
+++ b/authfd.c
@@ -752,3 +752,161 @@ ssh_agent_bind_hostkey(int sock, const struct sshkey *key,
 	sshbuf_free(msg);
 	return r;
 }
+
+int
+ssh_set_variable(int sock, const char *var, size_t lvar, const char *val, size_t lval)
+{
+	struct sshbuf *msg;
+	int r;
+	u_char type;
+
+	if ((msg = sshbuf_new()) == NULL)
+		return SSH_ERR_ALLOC_FAIL;
+	if ((r = sshbuf_put_u8(msg, SSH_AGENTC_SET_VARIABLE)) == 0 &&
+	    (r = sshbuf_put_string(msg, var, lvar)) == 0 &&
+	    (r = sshbuf_put_string(msg, val, lval)) == 0 &&
+	    (r = ssh_request_reply(sock, msg, msg)) == 0 &&
+	    (r = sshbuf_get_u8(msg, &type)) == 0) {
+		r = (type == SSH_AGENT_VARIABLE_REPLACED) ? 1 : decode_reply(type);
+	}
+	sshbuf_free(msg);
+	return r;
+}
+
+
+int
+ssh_get_variable(int sock, const char *var, size_t lvar, char **valp, size_t *lvalp)
+{
+	struct sshbuf *msg;
+	int r;
+	u_char type;
+
+	*valp= NULL;
+	if (lvalp) *lvalp= 0;
+	if ((msg = sshbuf_new()) == NULL)
+		return SSH_ERR_ALLOC_FAIL;
+	if ((r = sshbuf_put_u8(msg, SSH_AGENTC_GET_VARIABLE)) == 0 &&
+	    (r = sshbuf_put_string(msg, var, lvar)) == 0 &&
+	    (r = ssh_request_reply(sock, msg, msg)) == 0 &&
+	    (r = sshbuf_get_u8(msg, &type)) == 0) {
+		if (type == SSH_AGENT_GET_VARIABLE_ANSWER) {
+			r = sshbuf_get_string(msg, (u_char**)valp, lvalp);
+		} else if (type == SSH_AGENT_NO_VARIABLE) {
+			r = 1;
+		} else if ((r = decode_reply(type)) == 0) {
+			r = SSH_ERR_INVALID_FORMAT;
+		}
+	}
+	sshbuf_free(msg);
+	return r;
+}
+
+
+/*
+ * Returns the first variable held by the agent.
+ */
+
+static int
+ssh_get_num_variables(int sock, const char *prefix, size_t lprefix, char full, struct sshbuf **buf, u_int32_t *howmany)
+{
+	struct sshbuf *request = NULL;
+	int r;
+	u_char type;
+
+	*howmany = 0;
+	*buf = NULL;
+	if (!prefix) {
+		prefix = "";
+		lprefix = 0;
+	}
+	if ((request = sshbuf_new()) == NULL) {
+		return SSH_ERR_ALLOC_FAIL;
+	} else if ((r = sshbuf_put_u8(request, full ? SSH_AGENTC_LIST_VARIABLES : SSH_AGENTC_LIST_VARIABLE_NAMES)) == 0 &&
+	           (r = sshbuf_put_string(request, prefix, lprefix)) == 0) {
+		if ((*buf = sshbuf_new()) == NULL)
+			r = SSH_ERR_ALLOC_FAIL;
+		else if ((r = ssh_request_reply(sock, request, *buf)) == 0 &&
+		         (r = sshbuf_get_u8(*buf, &type)) == 0) {
+			/* Get message type, and verify that we got a proper answer. */
+			if (type != (full ? SSH_AGENT_VARIABLES_ANSWER : SSH_AGENT_VARIABLE_NAMES_ANSWER)) {
+				if ((r = decode_reply(type)) == 0)
+					r = SSH_ERR_INVALID_FORMAT;
+			/* Get the number of entries in the response and check it for sanity. */
+			} else if ((r = sshbuf_get_u32(*buf, howmany)) == 0) {
+				if (*howmany > 1024)
+					r = SSH_ERR_INVALID_FORMAT;
+			}
+		}
+	}
+
+	if (r!=0 && *buf) sshbuf_free(*buf);
+	sshbuf_free(request);
+	return r;
+}
+
+int
+ssh_get_first_variable(int sock, const char *prefix, size_t lprefix, char full,
+                       char **varp, size_t *lvarp, char **valp, size_t *lvalp,
+                       struct sshbuf **buf, u_int32_t *howmany)
+{
+	int r;
+	/* get number of variables and return the first entry (if any). */
+	if ((r = ssh_get_num_variables(sock, prefix, lprefix, full, buf, howmany)) != 0) return r;
+	return ssh_get_next_variable(sock, full, varp, lvarp, valp, lvalp, buf, howmany);
+}
+
+int
+ssh_get_next_variable(int sock, char full,
+                      char **varp, size_t *lvarp, char **valp, size_t *lvalp,
+                      struct sshbuf **buf, u_int32_t *howmany)
+{
+	int r;
+
+	*varp = NULL;
+	if (valp) *valp = NULL;
+	*lvarp = 0;
+	if (lvalp) *lvalp = 0;
+	/* Return failure if no more entries. */
+	if (*howmany <= 0) {
+		if (*buf) sshbuf_free(*buf);
+		*buf = NULL;
+		return SSH_AGENT_NO_VARIABLE;
+	}
+
+	/*
+	 * Get the next entry from the packet.
+	 */
+	if ((r = sshbuf_get_string(*buf, (u_char**)varp, lvarp)) == 0 &&
+	    (r = full ? sshbuf_get_string(*buf, (u_char**)valp, lvalp) : 0) == 0) {
+		/* Decrement the number of remaining entries. */
+		(*howmany)--;
+		return 0;
+	} else {
+		if (*buf) sshbuf_free(*buf);
+		*buf = NULL;
+		return r;
+	}
+}
+
+int
+ssh_delete_variable(int sock, const char *var, size_t lvar, char all)
+{
+	struct sshbuf *msg;
+	int r;
+	u_char type;
+	if (all && !var) {
+		var = "";
+		lvar = 0;
+	}
+
+	if ((msg = sshbuf_new()) == NULL)
+		return SSH_ERR_ALLOC_FAIL;
+	if ((r = sshbuf_put_u8(msg, all ? SSH_AGENTC_REMOVE_ALL_VARIABLES : SSH_AGENTC_REMOVE_VARIABLE)) == 0 &&
+	    (r = sshbuf_put_string(msg, var, lvar)) == 0 &&
+	    (r = ssh_request_reply(sock, msg, msg)) == 0 &&
+	    (r = sshbuf_get_u8(msg, &type)) == 0) {
+		r = (type == SSH_AGENT_NO_VARIABLE) ? 1 : decode_reply(type);
+	}
+	sshbuf_free(msg);
+	return r;
+}
diff --git a/authfd.h b/authfd.h
index 7a1c0ddff..cd3b764e5 100644
--- a/authfd.h
+++ b/authfd.h
@@ -103,6 +103,19 @@ int	ssh_agent_bind_hostkey(int sock, const struct sshkey *key,
 /* generic extension mechanism */
 #define SSH_AGENTC_EXTENSION			27
 
+/* ssh-store commands */
+#define SSH_AGENTC_SET_VARIABLE			40
+#define SSH_AGENT_VARIABLE_REPLACED		41
+#define SSH_AGENTC_GET_VARIABLE			42
+#define SSH_AGENT_GET_VARIABLE_ANSWER		43
+#define SSH_AGENT_NO_VARIABLE			44
+#define SSH_AGENTC_LIST_VARIABLE_NAMES		45
+#define SSH_AGENT_VARIABLE_NAMES_ANSWER		46
+#define SSH_AGENTC_LIST_VARIABLES		47
+#define SSH_AGENT_VARIABLES_ANSWER		48
+#define SSH_AGENTC_REMOVE_VARIABLE		49
+#define SSH_AGENTC_REMOVE_ALL_VARIABLES		50
+
 #define	SSH_AGENT_CONSTRAIN_LIFETIME		1
 #define	SSH_AGENT_CONSTRAIN_CONFIRM		2
 #define	SSH_AGENT_CONSTRAIN_MAXSIGN		3
@@ -118,4 +131,15 @@ int	ssh_agent_bind_hostkey(int sock, const struct sshkey *key,
 #define	SSH_AGENT_RSA_SHA2_256			0x02
 #define	SSH_AGENT_RSA_SHA2_512			0x04
 
+int
+ssh_set_variable(int, const char *, size_t, const char *, size_t);
+int
+ssh_get_variable(int, const char *, size_t, char **, size_t *);
+int
+ssh_get_first_variable(int, const char *, size_t, char, char **, size_t *, char **, size_t *, struct sshbuf **, u_int32_t *);
+int
+ssh_get_next_variable(int, char, char **, size_t *, char **, size_t *, struct sshbuf **, u_int32_t *);
+int
+ssh_delete_variable(int, const char *, size_t, char);
+
 #endif				/* AUTHFD_H */
diff --git a/contrib/win32/install/client.wxs b/contrib/win32/install/client.wxs
index 8918abd18..9ed5e1c6d 100644
--- a/contrib/win32/install/client.wxs
+++ b/contrib/win32/install/client.wxs
@@ -13,6 +13,9 @@
             <Component>
                 <File Name="ssh-add.exe" KeyPath="yes" />
             </Component>
+            <Component>
+                <File Name="ssh-store.exe" KeyPath="yes" />
+            </Component>
             <Component>
                 <File Name="ssh-keyscan.exe" KeyPath="yes" />
             </Component>
diff --git a/contrib/win32/openssh/AnalyzeCodeDiff.ps1 b/contrib/win32/openssh/AnalyzeCodeDiff.ps1
index a4b4953be..48cf7d1de 100644
--- a/contrib/win32/openssh/AnalyzeCodeDiff.ps1
+++ b/contrib/win32/openssh/AnalyzeCodeDiff.ps1
@@ -196,5 +196,6 @@ AnalyzeProject sftp
 AnalyzeProject sftp-server
 AnalyzeProject ssh
 AnalyzeProject ssh-add
+AnalyzeProject ssh-store
 AnalyzeProject ssh-agent
 AnalyzeProject sshd
\ No newline at end of file
diff --git a/contrib/win32/openssh/OpenSSHBuildHelper.psm1 b/contrib/win32/openssh/OpenSSHBuildHelper.psm1
index f4895ef8e..506f78266 100644
--- a/contrib/win32/openssh/OpenSSHBuildHelper.psm1
+++ b/contrib/win32/openssh/OpenSSHBuildHelper.psm1
@@ -317,7 +317,7 @@ function Start-OpenSSHPackage
     }    
 
     $buildDir = Join-Path $repositoryRoot ("bin\" + $folderName + "\" + $Configuration)
-    $payload =  "sshd.exe", "ssh.exe", "ssh-agent.exe", "ssh-add.exe", "sftp.exe"
+    $payload =  "sshd.exe", "ssh.exe", "ssh-agent.exe", "ssh-add.exe", "ssh-store.exe", "sftp.exe"
     $payload += "sftp-server.exe", "scp.exe", "ssh-shellhost.exe", "ssh-keygen.exe", "ssh-keyscan.exe", "ssh-sk-helper.exe", "ssh-pkcs11-helper.exe"
     $payload += "sshd_config_default", "install-sshd.ps1", "uninstall-sshd.ps1"
     $payload += "FixHostFilePermissions.ps1", "FixUserFilePermissions.ps1", "OpenSSHUtils.psm1", "OpenSSHUtils.psd1"
diff --git a/contrib/win32/openssh/SignConfig.xml b/contrib/win32/openssh/SignConfig.xml
index b39d2a622..bb2abc56f 100644
--- a/contrib/win32/openssh/SignConfig.xml
+++ b/contrib/win32/openssh/SignConfig.xml
@@ -7,6 +7,7 @@
     <file src="__INPATHROOT__\sftp-server.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\sftp-server.exe" />
     <file src="__INPATHROOT__\sftp.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\sftp.exe" />
     <file src="__INPATHROOT__\ssh-add.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\ssh-add.exe" />
+    <file src="__INPATHROOT__\ssh-store.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\ssh-store.exe" />
     <file src="__INPATHROOT__\ssh-agent.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\ssh-agent.exe" />
     <file src="__INPATHROOT__\ssh-keygen.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\ssh-keygen.exe" />
     <file src="__INPATHROOT__\ssh-keyscan.exe" signType="AuthenticodeDual" dest="__OUTPATHROOT__\ssh-keyscan.exe" />
diff --git a/contrib/win32/openssh/ssh-store.vcxproj b/contrib/win32/openssh/ssh-store.vcxproj
new file mode 100644
index 000000000..3ef770995
--- /dev/null
+++ b/contrib/win32/openssh/ssh-store.vcxproj
@@ -0,0 +1,423 @@
+﻿<?xml version="1.0" encoding="utf-8"?>
+<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
+  <Import Project="paths.targets" />
+  <ItemGroup Label="ProjectConfigurations">
+    <ProjectConfiguration Include="Debug|ARM">
+      <Configuration>Debug</Configuration>
+      <Platform>ARM</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Debug|ARM64">
+      <Configuration>Debug</Configuration>
+      <Platform>ARM64</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Debug|Win32">
+      <Configuration>Debug</Configuration>
+      <Platform>Win32</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Release|ARM">
+      <Configuration>Release</Configuration>
+      <Platform>ARM</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Release|ARM64">
+      <Configuration>Release</Configuration>
+      <Platform>ARM64</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Release|Win32">
+      <Configuration>Release</Configuration>
+      <Platform>Win32</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Debug|x64">
+      <Configuration>Debug</Configuration>
+      <Platform>x64</Platform>
+    </ProjectConfiguration>
+    <ProjectConfiguration Include="Release|x64">
+      <Configuration>Release</Configuration>
+      <Platform>x64</Platform>
+    </ProjectConfiguration>
+  </ItemGroup>
+  <ItemGroup>
+    <ClCompile Include="$(OpenSSH-Src-Path)ssh-store.c" />
+    <ClCompile Include="$(OpenSSH-Src-Path)contrib\win32\win32compat\wmain_common.c" />
+    <ClCompile Include="$(OpenSSH-Src-Path)ssh-sk-client.c" />
+    <ClCompile Include="..\win32compat\win32-utf8.c" />
+  </ItemGroup>
+  <ItemGroup>
+    <ResourceCompile Include="version.rc" />
+  </ItemGroup>
+  <ItemGroup>
+    <ClInclude Include="resource.h" />
+  </ItemGroup>
+  <PropertyGroup Label="Globals">
+    <ProjectGuid>{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}</ProjectGuid>
+    <Keyword>Win32Proj</Keyword>
+    <RootNamespace>keygen</RootNamespace>
+    <WindowsTargetPlatformVersion>$(WindowsSDKVersion)</WindowsTargetPlatformVersion>
+    <ProjectName>ssh-store</ProjectName>
+  </PropertyGroup>
+  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.Default.props" />
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>true</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>false</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <WholeProgramOptimization>true</WholeProgramOptimization>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>true</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>true</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>true</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>false</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <WholeProgramOptimization>true</WholeProgramOptimization>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>false</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <WholeProgramOptimization>true</WholeProgramOptimization>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="Configuration">
+    <ConfigurationType>Application</ConfigurationType>
+    <UseDebugLibraries>false</UseDebugLibraries>
+    <PlatformToolset>v143</PlatformToolset>
+    <WholeProgramOptimization>true</WholeProgramOptimization>
+    <CharacterSet>MultiByte</CharacterSet>
+    <SpectreMitigation>Spectre</SpectreMitigation>
+  </PropertyGroup>
+  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />
+  <ImportGroup Label="ExtensionSettings">
+  </ImportGroup>
+  <ImportGroup Label="Shared">
+  </ImportGroup>
+  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'" Label="PropertySheets">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'" Label="PropertySheets">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Label="PropertySheets" Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'" Label="PropertySheets">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <ImportGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'" Label="PropertySheets">
+    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" Label="LocalAppDataPlatform" />
+  </ImportGroup>
+  <PropertyGroup Label="UserMacros" />
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
+    <LinkIncremental>true</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
+    <LinkIncremental>true</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
+    <LinkIncremental>true</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
+    <LinkIncremental>true</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
+    <LinkIncremental>false</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
+    <LinkIncremental>false</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
+    <LinkIncremental>false</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <PropertyGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
+    <LinkIncremental>false</LinkIncremental>
+    <OutDir>$(OpenSSH-Bin-Path)$(Platform)\$(Configuration)\</OutDir>
+    <IntDir>$(Platform)\$(Configuration)\$(TargetName)\</IntDir>
+    <IncludePath>$(OpenSSH-Src-Path)contrib\win32\win32compat\inc;$(VC_IncludePath);$(WindowsSDK_IncludePath);</IncludePath>
+  </PropertyGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|Win32'">
+    <ClCompile>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <WarningLevel>Level1</WarningLevel>
+      <Optimization>Disabled</Optimization>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;WIN32;_DEBUG;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>false</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
+      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-x86-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no /CETCOMPAT %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|x64'">
+    <ClCompile>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <WarningLevel>Level1</WarningLevel>
+      <Optimization>Disabled</Optimization>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;WIN32;_DEBUG;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>false</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
+      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-x64-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no /CETCOMPAT %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM64'">
+    <ClCompile>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <WarningLevel>Level1</WarningLevel>
+      <Optimization>Disabled</Optimization>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;WIN32;_DEBUG;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>false</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
+      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-arm64-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Debug|ARM'">
+    <ClCompile>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <WarningLevel>Level1</WarningLevel>
+      <Optimization>Disabled</Optimization>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;WIN32;_DEBUG;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>false</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreadedDebug</RuntimeLibrary>
+      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-arm-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|Win32'">
+    <ClCompile>
+      <WarningLevel>Level1</WarningLevel>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <Optimization>MaxSpeed</Optimization>
+      <FunctionLevelLinking>true</FunctionLevelLinking>
+      <IntrinsicFunctions>true</IntrinsicFunctions>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>true</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <EnableCOMDATFolding>true</EnableCOMDATFolding>
+      <OptimizeReferences>true</OptimizeReferences>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-x86-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <FullProgramDatabaseFile>true</FullProgramDatabaseFile>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no /CETCOMPAT %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|x64'">
+    <ClCompile>
+      <WarningLevel>Level1</WarningLevel>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <Optimization>MaxSpeed</Optimization>
+      <FunctionLevelLinking>true</FunctionLevelLinking>
+      <IntrinsicFunctions>true</IntrinsicFunctions>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>true</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <EnableCOMDATFolding>true</EnableCOMDATFolding>
+      <OptimizeReferences>true</OptimizeReferences>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-x64-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <FullProgramDatabaseFile>true</FullProgramDatabaseFile>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no /CETCOMPAT %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM64'">
+    <ClCompile>
+      <WarningLevel>Level1</WarningLevel>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <Optimization>MaxSpeed</Optimization>
+      <FunctionLevelLinking>true</FunctionLevelLinking>
+      <IntrinsicFunctions>true</IntrinsicFunctions>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>true</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <EnableCOMDATFolding>true</EnableCOMDATFolding>
+      <OptimizeReferences>true</OptimizeReferences>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-arm64-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <FullProgramDatabaseFile>true</FullProgramDatabaseFile>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <ItemDefinitionGroup Condition="'$(Configuration)|$(Platform)'=='Release|ARM'">
+    <ClCompile>
+      <WarningLevel>Level1</WarningLevel>
+      <PrecompiledHeader>
+      </PrecompiledHeader>
+      <Optimization>MaxSpeed</Optimization>
+      <FunctionLevelLinking>true</FunctionLevelLinking>
+      <IntrinsicFunctions>true</IntrinsicFunctions>
+      <PreprocessorDefinitions>_WIN32_WINNT=0x601;_LIB;_CRT_SECURE_NO_WARNINGS;_CRT_NONSTDC_NO_WARNINGS;_WINSOCK_DEPRECATED_NO_WARNINGS;WIN32;NDEBUG;_CONSOLE;%(PreprocessorDefinitions)</PreprocessorDefinitions>
+      <SDLCheck>true</SDLCheck>
+      <AdditionalIncludeDirectories>$(SolutionDir);$(LibreSSL-Path)include;$(OpenSSH-Src-Path)includes;$(OpenSSH-Src-Path);$(OpenSSH-Src-Path)contrib\win32\win32compat;$(OpenSSH-Src-Path)libkrb;$(OpenSSH-Src-Path)libkrb\libKrb5;%(AdditionalIncludeDirectories)</AdditionalIncludeDirectories>
+      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
+      <ControlFlowGuard>Guard</ControlFlowGuard>
+      <AdditionalOptions>/Gy /ZH:SHA_256 %(AdditionalOptions)</AdditionalOptions>
+    </ClCompile>
+    <Link>
+      <SubSystem>Console</SubSystem>
+      <GenerateDebugInformation>true</GenerateDebugInformation>
+      <EnableCOMDATFolding>true</EnableCOMDATFolding>
+      <OptimizeReferences>true</OptimizeReferences>
+      <AdditionalDependencies>posix_compat.lib;libssh.lib;openbsd_compat.lib;$(SSLLib)$(AdditionalDependentLibs);%(AdditionalDependencies)</AdditionalDependencies>
+      <AdditionalLibraryDirectories>$(OpenSSH-Lib-Path)$(Platform)\$(Configuration);$(LibreSSL-arm-Path);%(AdditionalLibraryDirectories)</AdditionalLibraryDirectories>
+      <EntryPointSymbol>wmainCRTStartup</EntryPointSymbol>
+      <FullProgramDatabaseFile>true</FullProgramDatabaseFile>
+      <AdditionalOptions>/debug /debugtype:cv,fixup /opt:ref /opt:icf /incremental:no %(AdditionalOptions)</AdditionalOptions>
+    </Link>
+    <Manifest>
+      <AdditionalManifestFiles>targetos.manifest</AdditionalManifestFiles>
+    </Manifest>
+  </ItemDefinitionGroup>
+  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />
+  <ImportGroup Label="ExtensionTargets">
+  </ImportGroup>
+</Project>
\ No newline at end of file
diff --git a/contrib/win32/openssh/ssh-store.vcxproj.filters b/contrib/win32/openssh/ssh-store.vcxproj.filters
new file mode 100644
index 000000000..e033fc689
--- /dev/null
+++ b/contrib/win32/openssh/ssh-store.vcxproj.filters
@@ -0,0 +1,41 @@
+﻿<?xml version="1.0" encoding="utf-8"?>
+<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
+  <ItemGroup>
+    <Filter Include="Source Files">
+      <UniqueIdentifier>{4FC737F1-C7A5-4376-A066-2A32D752A2FF}</UniqueIdentifier>
+      <Extensions>cpp;c;cc;cxx;def;odl;idl;hpj;bat;asm;asmx</Extensions>
+    </Filter>
+    <Filter Include="Header Files">
+      <UniqueIdentifier>{93995380-89BD-4b04-88EB-625FBE52EBFB}</UniqueIdentifier>
+      <Extensions>h;hh;hpp;hxx;hm;inl;inc;xsd</Extensions>
+    </Filter>
+    <Filter Include="Resource Files">
+      <UniqueIdentifier>{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}</UniqueIdentifier>
+      <Extensions>rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav;mfcribbon-ms</Extensions>
+    </Filter>
+  </ItemGroup>
+  <ItemGroup>
+    <ClCompile Include="$(OpenSSH-Src-Path)ssh-store.c">
+      <Filter>Source Files</Filter>
+    </ClCompile>
+    <ClCompile Include="$(OpenSSH-Src-Path)contrib\win32\win32compat\wmain_common.c">
+      <Filter>Source Files</Filter>
+    </ClCompile>
+    <ClCompile Include="$(OpenSSH-Src-Path)ssh-sk-client.c">
+      <Filter>Source Files</Filter>
+    </ClCompile>
+    <ClCompile Include="..\win32compat\win32-utf8.c">
+      <Filter>Source Files</Filter>
+    </ClCompile>
+  </ItemGroup>
+  <ItemGroup>
+    <ResourceCompile Include="version.rc">
+      <Filter>Resource Files</Filter>
+    </ResourceCompile>
+  </ItemGroup>
+  <ItemGroup>
+    <ClInclude Include="resource.h">
+      <Filter>Header Files</Filter>
+    </ClInclude>
+  </ItemGroup>
+</Project>
\ No newline at end of file
diff --git a/contrib/win32/openssh/Win32-OpenSSH.sln b/contrib/win32/openssh/Win32-OpenSSH.sln
index 40732fe3b..d6e64be79 100644
--- a/contrib/win32/openssh/Win32-OpenSSH.sln
+++ b/contrib/win32/openssh/Win32-OpenSSH.sln
@@ -81,6 +81,14 @@ Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ssh-add", "ssh-add.vcxproj"
 		{0D02F0F0-013B-4EE3-906D-86517F3822C0} = {0D02F0F0-013B-4EE3-906D-86517F3822C0}
 	EndProjectSection
 EndProject
+Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "ssh-store", "ssh-store.vcxproj", "{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}"
+	ProjectSection(ProjectDependencies) = postProject
+		{05E1115F-8529-46D0-AAAF-52A404CE79A7} = {05E1115F-8529-46D0-AAAF-52A404CE79A7}
+		{8F9D3B74-8D33-448E-9762-26E8DCC6B2F4} = {8F9D3B74-8D33-448E-9762-26E8DCC6B2F4}
+		{DD483F7D-C553-4740-BC1A-903805AD0174} = {DD483F7D-C553-4740-BC1A-903805AD0174}
+		{0D02F0F0-013B-4EE3-906D-86517F3822C0} = {0D02F0F0-013B-4EE3-906D-86517F3822C0}
+	EndProjectSection
+EndProject
 Project("{8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942}") = "scp", "scp.vcxproj", "{29B98ADF-1285-49CE-BF6C-AA92C5D2FB24}"
 	ProjectSection(ProjectDependencies) = postProject
 		{05E1115F-8529-46D0-AAAF-52A404CE79A7} = {05E1115F-8529-46D0-AAAF-52A404CE79A7}
@@ -384,6 +392,22 @@ Global
 		{029797FF-C986-43DE-95CD-2E771E86AEBC}.Release|x64.Build.0 = Release|x64
 		{029797FF-C986-43DE-95CD-2E771E86AEBC}.Release|x86.ActiveCfg = Release|Win32
 		{029797FF-C986-43DE-95CD-2E771E86AEBC}.Release|x86.Build.0 = Release|Win32
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|ARM.ActiveCfg = Debug|ARM
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|ARM.Build.0 = Debug|ARM
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|ARM64.ActiveCfg = Debug|ARM64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|ARM64.Build.0 = Debug|ARM64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|x64.ActiveCfg = Debug|x64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|x64.Build.0 = Debug|x64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|x86.ActiveCfg = Debug|Win32
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Debug|x86.Build.0 = Debug|Win32
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|ARM.ActiveCfg = Release|ARM
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|ARM.Build.0 = Release|ARM
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|ARM64.ActiveCfg = Release|ARM64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|ARM64.Build.0 = Release|ARM64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|x64.ActiveCfg = Release|x64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|x64.Build.0 = Release|x64
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|x86.ActiveCfg = Release|Win32
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC}.Release|x86.Build.0 = Release|Win32
 		{29B98ADF-1285-49CE-BF6C-AA92C5D2FB24}.Debug|ARM.ActiveCfg = Debug|ARM
 		{29B98ADF-1285-49CE-BF6C-AA92C5D2FB24}.Debug|ARM.Build.0 = Debug|ARM
 		{29B98ADF-1285-49CE-BF6C-AA92C5D2FB24}.Debug|ARM64.ActiveCfg = Debug|ARM64
@@ -593,6 +617,7 @@ Global
 		{C0AE8A30-E4FA-49CE-A2B5-0C072C77EC64} = {17322AAF-808F-4646-AD37-5B0EDDCB8F3E}
 		{F6644EC5-D6B6-42A1-828C-75E2977470E0} = {17322AAF-808F-4646-AD37-5B0EDDCB8F3E}
 		{029797FF-C986-43DE-95CD-2E771E86AEBC} = {17322AAF-808F-4646-AD37-5B0EDDCB8F3E}
+		{306D867D-55FE-42AD-9C9D-E1E5D206BAAC} = {17322AAF-808F-4646-AD37-5B0EDDCB8F3E}
 		{29B98ADF-1285-49CE-BF6C-AA92C5D2FB24} = {17322AAF-808F-4646-AD37-5B0EDDCB8F3E}
 		{D901596E-76C7-4608-9CFA-2B42A9FD7250} = {A8096E32-E084-4FA0-AE01-A8D909EB2BB4}
 		{8EC56B06-5A9A-4D6D-804D-037FE26FD43E} = {A8096E32-E084-4FA0-AE01-A8D909EB2BB4}
diff --git a/contrib/win32/win32compat/ssh-agent/agent.c b/contrib/win32/win32compat/ssh-agent/agent.c
index adac352c9..3adaa5cb0 100644
--- a/contrib/win32/win32compat/ssh-agent/agent.c
+++ b/contrib/win32/win32compat/ssh-agent/agent.c
@@ -156,9 +156,8 @@ agent_listen_loop()
 			GetNamedPipeClientProcessId(con, &client_pid);
 			verbose("client pid %d connected", client_pid);
 			if (debug_mode) {
+				/*debug mode: process each request one at a time */
 				agent_process_connection(con);
-				agent_cleanup();
-				return;
 			} else {
 				/* spawn a child to take care of this*/
 				wchar_t path[PATH_MAX], module_path[PATH_MAX];
diff --git a/contrib/win32/win32compat/ssh-agent/agent.h b/contrib/win32/win32compat/ssh-agent/agent.h
index 5313d7e6e..3bb3a54a3 100644
--- a/contrib/win32/win32compat/ssh-agent/agent.h
+++ b/contrib/win32/win32compat/ssh-agent/agent.h
@@ -10,6 +10,8 @@
 #define SSH_KEYS_ROOT SSH_AGENT_ROOT L"\\" SSH_KEYS_KEY
 #define SSH_PKCS11_PROVIDERS_KEY L"PKCS11_Providers"
 #define SSH_PKCS11_PROVIDERS_ROOT SSH_AGENT_ROOT L"\\" SSH_PKCS11_PROVIDERS_KEY
+#define SSH_VARIABLES_KEY L"Variables"
+#define SSH_VARIABLES_ROOT SSH_AGENT_ROOT L"\\" SSH_VARIABLES_KEY
 /* Maximum number of recorded session IDs/hostkeys per connection */
 #define AGENT_MAX_SESSION_IDS		16
 /* Maximum size of session ID */
diff --git a/contrib/win32/win32compat/ssh-agent/agent-request.h b/contrib/win32/win32compat/ssh-agent/agent-request.h
index 79cc8f8f2..7b69923db 100644
--- a/contrib/win32/win32compat/ssh-agent/agent-request.h
+++ b/contrib/win32/win32compat/ssh-agent/agent-request.h
@@ -22,4 +22,11 @@ int process_add_smartcard_key(struct sshbuf*, struct sshbuf*, struct agent_conne
 int process_remove_smartcard_key(struct sshbuf*, struct sshbuf*, struct agent_connection*);
 int process_extension(struct sshbuf*, struct sshbuf*, struct agent_connection*);
 
+int process_remove_all(struct sshbuf*, struct sshbuf*, struct agent_connection*);
+int process_set_variable(struct sshbuf*, struct sshbuf*, struct agent_connection*);
+int process_get_variable(struct sshbuf*, struct sshbuf*, struct agent_connection*);
+int process_list_variables(struct sshbuf*, struct sshbuf*, struct agent_connection*, char full);
+int process_remove_variable(struct sshbuf*, struct sshbuf*, struct agent_connection*);
+int process_remove_all_variables(struct sshbuf*, struct sshbuf*, struct agent_connection*);
+
 /* auth */
diff --git a/contrib/win32/win32compat/ssh-agent/connection.c b/contrib/win32/win32compat/ssh-agent/connection.c
index d8977a15d..bea38f1bf 100644
--- a/contrib/win32/win32compat/ssh-agent/connection.c
+++ b/contrib/win32/win32compat/ssh-agent/connection.c
@@ -170,6 +170,24 @@ process_request(struct agent_connection* con)
 	case SSH_AGENTC_EXTENSION:
 		r = process_extension(request, response, con);
 		break;
+	case SSH_AGENTC_SET_VARIABLE:
+		r = process_set_variable(request, response, con);
+		break;
+	case SSH_AGENTC_GET_VARIABLE:
+		r = process_get_variable(request, response, con);
+		break;
+	case SSH_AGENTC_LIST_VARIABLE_NAMES:
+		r = process_list_variables(request, response, con, 0);
+		break;
+	case SSH_AGENTC_LIST_VARIABLES:
+		r = process_list_variables(request, response, con, 1);
+		break;
+	case SSH_AGENTC_REMOVE_VARIABLE:
+		r = process_remove_variable(request, response, con);
+		break;
+	case SSH_AGENTC_REMOVE_ALL_VARIABLES:
+		r = process_remove_all_variables(request, response, con);
+		break;
 	default:
 		debug("unknown agent request %d", type);
 		r = -1;
diff --git a/contrib/win32/win32compat/ssh-agent/keyagent-request.c b/contrib/win32/win32compat/ssh-agent/keyagent-request.c
index 0304f589f..8ec9c33e7 100644
--- a/contrib/win32/win32compat/ssh-agent/keyagent-request.c
+++ b/contrib/win32/win32compat/ssh-agent/keyagent-request.c
@@ -1068,4 +1068,290 @@ int process_keyagent_request(struct sshbuf* request, struct sshbuf* response, st
 }
 #endif
 
+static void
+send_return_code(struct sshbuf* response, int code)
+{
+	int r;
+	debug("return code %d", code);
+	if ((r = sshbuf_put_u8(response, code)) != 0)
+		fatal_fr(r, "compose");
+}
+
+int
+process_set_variable(struct sshbuf* request, struct sshbuf* response, struct agent_connection* con)
+{
+	size_t lvar = 0, lval = 0;
+	DWORD loldval = 0, oldtype = 0;
+	char *var = 0, *val = 0;
+	LPSTR svar = 0;
+	int r, ret = SSH_AGENT_FAILURE;
+	int replace = 0, stage = 0;
+	HKEY reg = 0, user_root = 0;
+	SECURITY_ATTRIBUTES sa;
+
+	if ((r = sshbuf_get_string(request, (u_char**)&var, &lvar)) != 0 ||
+	    (r = sshbuf_get_string(request, (u_char**)&val, &lval)) != 0)
+		error_fr(r, "parse");
+	else {
+		svar = malloc(lvar + 1);
+		if (!svar) fatal_f("malloc");
+		memcpy(svar, var, lvar);
+		svar[lvar] = '\0';
+
+		memset(&sa, 0, sizeof(SECURITY_ATTRIBUTES));
+		sa.nLength = sizeof(sa);
+		if ((stage++, !ConvertStringSecurityDescriptorToSecurityDescriptorW(REG_KEY_SDDL, SDDL_REVISION_1, &sa.lpSecurityDescriptor, &sa.nLength)) ||
+		    (stage++, (r = get_user_root(con, &user_root)) != 0) ||
+		    (stage++, (r = RegCreateKeyExW(user_root, SSH_VARIABLES_ROOT, 0, 0, 0, KEY_WRITE | KEY_QUERY_VALUE | KEY_WOW64_64KEY, &sa, &reg, NULL)) != ERROR_SUCCESS))
+			error_f("error %d at stage %d setting '%.*s' = '%.*s'", r, stage, lvar, var, lval, val);
+		else {
+			replace = (RegQueryValueExA(reg, svar, 0, &oldtype, NULL, &loldval) == ERROR_SUCCESS && oldtype == REG_BINARY);
+			if ((r = RegSetValueExA(reg, svar, 0, REG_BINARY, val, (DWORD)lval)) != ERROR_SUCCESS)
+				error_f("RegSetValueExA error %d setting '%.*s' = '%.*s'", r, lvar, var, lval, val);
+			else {
+				if (replace) {
+					debug("set '%.*s' = '%.*s' (replacing %d-byte old value)", lvar, var, lval, val, loldval);
+					ret = SSH_AGENT_VARIABLE_REPLACED;
+				} else {
+					debug("set '%.*s' = '%.*s'", lvar, var, lval, val);
+					ret = SSH_AGENT_SUCCESS;
+				}
+			}
+		}
+	}
+
+	if (reg) RegCloseKey(reg);
+	if (user_root) RegCloseKey(user_root);
+	if (sa.lpSecurityDescriptor) LocalFree(sa.lpSecurityDescriptor);
+	free(svar);
+	free(val);
+	free(var);
+
+	send_return_code(response, ret);
+	return 0;
+}
+
+
+int
+process_get_variable(struct sshbuf* request, struct sshbuf* response, struct agent_connection* con)
+{
+	size_t lvar = 0;
+	DWORD lval = 0, type = 0;
+	char *var = 0, *val = 0;
+	LPSTR svar = 0;
+	int r, success = 0, stage = 0;
+	HKEY reg = 0, user_root = 0;
+
+	if ((r = sshbuf_get_string(request, (u_char**)&var, &lvar)) != 0) {
+		error_fr(r, "parse");
+		send_return_code(response, SSH_AGENT_FAILURE);
+		return 0;
+	}
+
+	svar = malloc(lvar + 1);
+	if (!svar) fatal_f("malloc");
+	memcpy(svar, var, lvar);
+	svar[lvar] = '\0';
+	if ((stage++, (r = get_user_root(con, &user_root)) != 0) ||
+	    (stage++, (r = RegOpenKeyExW(user_root, SSH_VARIABLES_ROOT, 0, STANDARD_RIGHTS_READ | KEY_QUERY_VALUE | KEY_WOW64_64KEY, &reg)) != ERROR_SUCCESS) ||
+	    (stage++, (r = RegQueryValueExA(reg, svar, 0, &type, NULL, &lval)) != ERROR_SUCCESS) ||
+	    (stage++, (type != REG_BINARY)) ||
+	    (stage++, (val = malloc(lval)) == NULL) ||
+	    (stage++, (r = RegQueryValueExA(reg, svar, 0, NULL, val, &lval)) != ERROR_SUCCESS)) {
+		if (stage == 3 || stage == 4) {
+			debug("variable '%.*s' not found", lvar, var);
+		} else {
+			debug_f("error %d at stage %d getting variable '%.*s'", r, stage, lvar, var);
+		}
+		send_return_code(response, SSH_AGENT_NO_VARIABLE);
+	} else {
+		debug("get '%.*s' -> '%.*s'", lvar, var, lval, val);
+		if ((r = sshbuf_put_u8(response, SSH_AGENT_GET_VARIABLE_ANSWER)) != 0 ||
+		    (r = sshbuf_put_string(response, val, lval)) != 0)
+			fatal_fr(r, "compose");
+	}
+
+	free(val);
+	free(svar);
+	free(var);
+	if (reg) RegCloseKey(reg);
+	if (user_root) RegCloseKey(user_root);
+	return 0;
+}
+
+/* send list of variables */
+int
+process_list_variables(struct sshbuf* request, struct sshbuf* response, struct agent_connection* con, char full)
+{
+	struct sshbuf *msg = NULL;
+	char *prefix = NULL, *var = NULL, *val = NULL;
+	size_t lprefix = 0;
+	u_int nret = 0;
+	int r, ret = SSH_AGENT_FAILURE, stage = 0;
+	DWORD nvar = 0, maxvar = 0, maxval = 0, index = 0, lvar, lval, type;
+	HKEY reg = 0, user_root = 0;
+
+	if ((stage++, (r = get_user_root(con, &user_root)) != 0) ||
+	    (stage++, (r = RegOpenKeyExW(user_root, SSH_VARIABLES_ROOT, 0, STANDARD_RIGHTS_READ | KEY_QUERY_VALUE | KEY_WOW64_64KEY, &reg)) != 0) ||
+	    (stage++, (r = RegQueryInfoKeyW(reg, NULL, NULL, NULL, NULL, NULL, NULL, &nvar, &maxvar, &maxval, NULL, NULL) != ERROR_SUCCESS))) {
+		error_f("failed to list variables at stage %d, error %d", stage, r);
+	} else if (nvar > 0) {
+		var = malloc(++maxvar);
+		if (!var) fatal_f("malloc failed");
+		if (full) {
+			val = malloc(maxval);
+			if (!val) fatal_f("malloc failed");
+		}
+		if ((r = sshbuf_get_string(request, (u_char**)&prefix, &lprefix)) != 0)
+			lprefix = 0;
+		if (lprefix > 0)
+			debug("list variables starting with '%.*s'", lprefix, prefix);
+		else
+			debug("list all variables");
+		if ((msg = sshbuf_new()) == NULL) fatal_f("sshbuf_new failed");
+		while (1) {
+			lvar = maxvar;  // includes space for terminating \0 of largest variable name
+			lval = maxval;
+			type = 0;
+			if ((r = RegEnumValueA(reg, index++, var, &lvar, NULL, &type, val, full ? &lval : NULL)) != ERROR_SUCCESS) {
+				debug_f("RegEnumValueA return code %d", r);
+				break;
+			}
+			if (type == REG_BINARY &&
+			    (lprefix == 0 || (lvar >= lprefix && 0 == memcmp (var, prefix, lprefix)))) {
+				if (full) debug("  -> '%.*s' = '%.*s'", lvar, var, lval, val);
+				else      debug("  -> '%.*s'",          lvar, var);
+				if ((r = sshbuf_put_string(msg, var, lvar)) != 0 ||
+				    (r = full ? sshbuf_put_string(msg, val, lval) : 0) != 0)
+					fatal_fr(r, "compose");
+				nret++;
+			} else
+				debug_f("skip variable '%.*s'", lvar, var);
+		}
+		free(val);
+		free(var);
+		free(prefix);
+		ret = full ? SSH_AGENT_VARIABLES_ANSWER : SSH_AGENT_VARIABLE_NAMES_ANSWER;
+	}
+
+	if (reg) RegCloseKey(reg);
+	if (user_root) RegCloseKey(user_root);
+
+	if ((r = sshbuf_put_u8(response, ret)) != 0 ||
+	    (r = sshbuf_put_u32(response, nret)) != 0 ||
+	    (r = sshbuf_putb(response, msg)) != 0)
+		fatal_fr(r, "compose");
+	sshbuf_free(msg);
+	return 0;
+}
+
+/* shared */
+int
+process_remove_variable(struct sshbuf* request, struct sshbuf* response, struct agent_connection* con)
+{
+	size_t lvar = 0;
+	DWORD type = 0, lval = 0;
+	char *var = 0;
+	LPSTR svar = 0;
+	int r, stage = 0, ret = SSH_AGENT_FAILURE;
+	HKEY reg = 0, user_root = 0;
+
+	if ((r = sshbuf_get_string(request, (u_char**)&var, &lvar)) != 0)
+		error_fr(r, "parse");
+	else {
+		svar = malloc(lvar + 1);
+		if (!svar) fatal_f("malloc failed");
+		memcpy(svar, var, lvar);
+		svar[lvar] = '\0';
+		if ((stage++, (r = get_user_root(con, &user_root)) != 0) ||
+		    (stage++, (r = RegOpenKeyExW(user_root, SSH_VARIABLES_ROOT, 0, STANDARD_RIGHTS_READ | KEY_QUERY_VALUE | KEY_SET_VALUE | KEY_WOW64_64KEY, &reg)) != ERROR_SUCCESS) ||
+		    (stage++, (r = RegQueryValueExA(reg, svar, 0, &type, NULL, &lval)) != ERROR_SUCCESS) ||
+		    (stage++, (type != REG_BINARY))) {
+			if (stage == 3 || stage == 4) {
+				debug("variable '%.*s' to delete not found", lvar, var);
+			} else {
+				error_f("error %d at stage %d getting variable '%.*s' to delete", r, stage, lvar, var, stage);
+			}
+			ret = SSH_AGENT_NO_VARIABLE;
+		} else {
+			if ((r = RegDeleteValueA (reg, svar)) != ERROR_SUCCESS) {
+				error_f ("RegDeleteValueA error %d deleting variable '%.*s' (length %d)", r, lvar, var, lval);
+			} else {
+				debug("deleted variable '%.*s' (length %d)", lvar, var, lval);
+				ret = SSH_AGENT_SUCCESS;
+			}
+		}
+	}
+
+	if (reg) RegCloseKey(reg);
+	if (user_root) RegCloseKey(user_root);
+	free(svar);
+	free(var);
+	send_return_code(response, ret);
+	return 0;
+}
+
+int
+process_remove_all_variables(struct sshbuf* request, struct sshbuf* response, struct agent_connection* con)
+{
+	char *prefix = 0, *var = 0;
+	LPSTR svar = 0;
+	size_t lprefix = 0;
+	u_int ndel = 0;
+	int r, err = 0, stage = 0, ret = SSH_AGENT_FAILURE;
+	DWORD nvar = 0, maxvar = 0, index = 0, lvar = 0, type;
+	HKEY reg = 0, user_root = 0;
+
+	if ((stage++, (r = get_user_root(con, &user_root)) != 0) ||
+	    (stage++, (r = RegOpenKeyExW(user_root, SSH_VARIABLES_ROOT, 0, DELETE | KEY_ENUMERATE_SUB_KEYS | KEY_QUERY_VALUE | KEY_SET_VALUE | KEY_WOW64_64KEY, &reg)) != 0) ||
+	    (stage++, (r = RegQueryInfoKeyW(reg, NULL, NULL, NULL, NULL, NULL, NULL, &nvar, &maxvar, NULL, NULL, NULL)) != ERROR_SUCCESS))
+		error_f("error %d at stage %d", r, stage);
+	else {
+		stage++;
+		if ((r = sshbuf_get_string(request, (u_char**)&prefix, &lprefix)) != 0)
+			lprefix = 0;
+		if (lprefix == 0) {
+			debug("delete all %d variables", nvar);
+			if ((r = RegDeleteTreeW(reg, NULL)) != ERROR_SUCCESS) {
+				error_f("RegDeleteTreeW error %d", r);
+				err = nvar;
+			} else
+				ndel = nvar;
+		} else {
+			var = malloc(++maxvar);
+			if (!var) fatal_f("malloc failed");
+			debug("delete all variables starting with '%.*s'", lprefix, prefix);
+			while (1) {
+				lvar = maxvar;  // includes space for terminating \0 of largest variable name
+				type = 0;
+				if ((r = RegEnumValueA(reg, index++, var, &lvar, NULL, &type, NULL, NULL)) != ERROR_SUCCESS)  {
+					debug_f("RegEnumValueA return code %d", r);
+					break;
+				}
+				if (type == REG_BINARY && (lprefix == 0 || (lvar >= lprefix && 0 == memcmp (var, prefix, lprefix)))) {
+					if (RegDeleteValueA (reg, var) != ERROR_SUCCESS) {
+						err++;
+					} else {
+						debug("deleted variable '%.*s'", lvar, var);
+						ndel++;
+					}
+				} else
+					debug_f("skip variable '%.*s'", lvar, var);
+			}
+		}
+		if (err == 0)
+			ret = ndel ? SSH_AGENT_SUCCESS : SSH_AGENT_NO_VARIABLE;
+	}
+
+	free(var);
+	free(prefix);
+	if (reg) RegCloseKey(reg);
+	if (user_root) RegCloseKey(user_root);
+
+	/* Send success. */
+	send_return_code(response, ret);
+	return 0;
+}
+
+
 #pragma warning(pop)
diff --git a/Makefile.in b/Makefile.in
index 70287f51f..0291a3fa5 100644
--- a/Makefile.in
+++ b/Makefile.in
@@ -69,7 +69,7 @@ MKDIR_P=@MKDIR_P@
 
 .SUFFIXES: .lo
 
-TARGETS=ssh$(EXEEXT) sshd$(EXEEXT) ssh-add$(EXEEXT) ssh-keygen$(EXEEXT) ssh-keyscan${EXEEXT} ssh-keysign${EXEEXT} ssh-pkcs11-helper$(EXEEXT) ssh-agent$(EXEEXT) scp$(EXEEXT) sftp-server$(EXEEXT) sftp$(EXEEXT) ssh-sk-helper$(EXEEXT)
+TARGETS=ssh$(EXEEXT) sshd$(EXEEXT) ssh-add$(EXEEXT) ssh-store$(EXEEXT) ssh-keygen$(EXEEXT) ssh-keyscan${EXEEXT} ssh-keysign${EXEEXT} ssh-pkcs11-helper$(EXEEXT) ssh-agent$(EXEEXT) scp$(EXEEXT) sftp-server$(EXEEXT) sftp$(EXEEXT) ssh-sk-helper$(EXEEXT)
 
 XMSS_OBJS=\
 	ssh-xmss.o \
@@ -139,6 +139,8 @@ SCP_OBJS=	scp.o progressmeter.o $(SFTP_CLIENT_OBJS)
 
 SSHADD_OBJS=	ssh-add.o $(SKOBJS)
 
+SSHSTORE_OBJS=	ssh-store.o $(SKOBJS)
+
 SSHAGENT_OBJS=	ssh-agent.o ssh-pkcs11-client.o $(SKOBJS)
 
 SSHKEYGEN_OBJS=	ssh-keygen.o sshsig.o $(SKOBJS)
@@ -215,6 +217,9 @@ scp$(EXEEXT): $(LIBCOMPAT) libssh.a $(SCP_OBJS)
 ssh-add$(EXEEXT): $(LIBCOMPAT) libssh.a $(SSHADD_OBJS)
 	$(LD) -o $@ $(SSHADD_OBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS) $(CHANNELLIBS)
 
+ssh-store$(EXEEXT): $(LIBCOMPAT) libssh.a $(SSHSTORE_OBJS)
+	$(LD) -o $@ $(SSHSTORE_OBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS) $(CHANNELLIBS)
+
 ssh-agent$(EXEEXT): $(LIBCOMPAT) libssh.a $(SSHAGENT_OBJS)
 	$(LD) -o $@ $(SSHAGENT_OBJS) $(LDFLAGS) -lssh -lopenbsd-compat $(LIBS) $(CHANNELLIBS)
 
@@ -395,6 +400,7 @@ install-files:
 	$(INSTALL) -m 0755 $(STRIP_OPT) ssh$(EXEEXT) $(DESTDIR)$(bindir)/ssh$(EXEEXT)
 	$(INSTALL) -m 0755 $(STRIP_OPT) scp$(EXEEXT) $(DESTDIR)$(bindir)/scp$(EXEEXT)
 	$(INSTALL) -m 0755 $(STRIP_OPT) ssh-add$(EXEEXT) $(DESTDIR)$(bindir)/ssh-add$(EXEEXT)
+	$(INSTALL) -m 0755 $(STRIP_OPT) ssh-store$(EXEEXT) $(DESTDIR)$(bindir)/ssh-store$(EXEEXT)
 	$(INSTALL) -m 0755 $(STRIP_OPT) ssh-agent$(EXEEXT) $(DESTDIR)$(bindir)/ssh-agent$(EXEEXT)
 	$(INSTALL) -m 0755 $(STRIP_OPT) ssh-keygen$(EXEEXT) $(DESTDIR)$(bindir)/ssh-keygen$(EXEEXT)
 	$(INSTALL) -m 0755 $(STRIP_OPT) ssh-keyscan$(EXEEXT) $(DESTDIR)$(bindir)/ssh-keyscan$(EXEEXT)
@@ -471,6 +477,7 @@ uninstall:
 	-rm -f $(DESTDIR)$(bindir)/ssh$(EXEEXT)
 	-rm -f $(DESTDIR)$(bindir)/scp$(EXEEXT)
 	-rm -f $(DESTDIR)$(bindir)/ssh-add$(EXEEXT)
+	-rm -f $(DESTDIR)$(bindir)/ssh-store$(EXEEXT)
 	-rm -f $(DESTDIR)$(bindir)/ssh-agent$(EXEEXT)
 	-rm -f $(DESTDIR)$(bindir)/ssh-keygen$(EXEEXT)
 	-rm -f $(DESTDIR)$(bindir)/ssh-keyscan$(EXEEXT)
diff --git a/scp.c b/scp.c
index 6f6003f66..5e661e43d 100644
--- a/scp.c
+++ b/scp.c
@@ -679,7 +679,6 @@ main(int argc, char **argv)
 	args.list = remote_remote_args.list = NULL;
 	addargs(&args, "%s", ssh_program);
 	addargs(&args, "-x");
-	addargs(&args, "-oPermitLocalCommand=no");
 	addargs(&args, "-oClearAllForwardings=yes");
 	addargs(&args, "-oRemoteCommand=none");
 	addargs(&args, "-oRequestTTY=no");
diff --git a/sftp.c b/sftp.c
index 98a63cb97..36533bccf 100644
--- a/sftp.c
+++ b/sftp.c
@@ -2532,7 +2532,6 @@ main(int argc, char **argv)
 	args.list = NULL;
 	addargs(&args, "%s", ssh_program);
 	addargs(&args, "-oForwardX11 no");
-	addargs(&args, "-oPermitLocalCommand no");
 	addargs(&args, "-oClearAllForwardings yes");
 
 	ll = SYSLOG_LEVEL_INFO;
diff --git a/ssh-agent.c b/ssh-agent.c
index f52861163..0dc407eb8 100644
--- a/ssh-agent.c
+++ b/ssh-agent.c
@@ -153,6 +153,21 @@ struct idtable {
 /* private key table */
 struct idtable *idtab;
 
+typedef struct variable {
+	TAILQ_ENTRY(variable) next;
+	char *var;
+	char *val;
+	size_t lvar;
+	size_t lval;
+} Variable;
+
+typedef struct {
+	int nentries;
+	TAILQ_HEAD(varqueue, variable) varlist;
+} Vartab;
+
+Vartab vartable;
+
 int max_fd = 0;
 
 /* pid of shell == parent of agent */
@@ -235,6 +250,13 @@ free_dest_constraint_hop(struct dest_constraint_hop *dch)
 	free(dch->key_is_ca);
 }
 
+static void
+vartab_init(void)
+{
+	TAILQ_INIT(&vartable.varlist);
+	vartable.nentries = 0;
+}
+
 static void
 free_dest_constraints(struct dest_constraint *dcs, size_t ndcs)
 {
@@ -469,6 +491,14 @@ identity_permitted(Identity *id, SocketEntry *e, char *user,
 	return 0;
 }
 
+static void
+free_variable(Variable *v)
+{
+	free(v->var);
+	free(v->val);
+	free(v);
+}
+
 /* return matching private key for given public key */
 static Identity *
 lookup_identity(struct sshkey *key)
@@ -1583,6 +1613,213 @@ process_ext_session_bind(SocketEntry *e)
 	return r == 0 ? 1 : 0;
 }
 
+/* return variable entry for given name */
+static Variable *
+lookup_variable(const char *var, size_t lvar)
+{
+	Variable *v;
+
+	TAILQ_FOREACH(v, &vartable.varlist, next) {
+		if (lvar == v->lvar && 0 == memcmp(var, v->var, lvar))
+			return (v);
+	}
+	return (NULL);
+}
+
+static void
+send_return_code(SocketEntry *e, int code)
+{
+	int r;
+	debug("return code %d", code);
+	if ((r = sshbuf_put_u32(e->output, 1)) != 0 ||
+	    (r = sshbuf_put_u8(e->output, code)) != 0)
+		fatal_fr(r, "compose");
+}
+
+static void
+process_set_variable(SocketEntry *e)
+{
+	size_t lvar = 0, lval = 0;
+	char *var = NULL, *val = NULL;
+	Variable *v;
+	int r, ret = SSH_AGENT_FAILURE;
+
+	if ((r = sshbuf_get_string(e->request, (u_char**)&var, &lvar)) != 0 ||
+	    (r = sshbuf_get_string(e->request, (u_char**)&val, &lval)) != 0)
+		error_fr(r, "parse");
+	else {
+		if ((v = lookup_variable(var, lvar))) {
+			debug("set '%.*s' = '%.*s' (replacing old value '%.*s')", (int)lvar, var, (int)lval, val, (int)v->lval, v->val);
+			free(var);
+			free(v->val);
+			ret = SSH_AGENT_VARIABLE_REPLACED;
+		} else {
+			debug("set '%.*s' = '%.*s'", (int)lvar, var, (int)lval, val);
+			if ((v = xmalloc(sizeof(Variable))) == NULL)
+				fatal_f("xmalloc failed");
+			v->var = var;
+			v->lvar = lvar;
+			TAILQ_INSERT_TAIL(&vartable.varlist, v, next);
+			vartable.nentries++;
+			ret = SSH_AGENT_SUCCESS;
+		}
+		v->val = val;
+		v->lval = lval;
+	}
+	send_return_code(e, ret);
+}
+
+static void
+process_get_variable(SocketEntry *e)
+{
+	size_t lvar = 0;
+	char *var = NULL;
+	Variable *v;
+	struct sshbuf *msg;
+	int r;
+
+	if ((r = sshbuf_get_string(e->request, (u_char**)&var, &lvar)) != 0) {
+		error_fr(r, "parse");
+		send_return_code(e, SSH_AGENT_FAILURE);
+		return;
+	}
+	if ((v = lookup_variable(var, lvar))) {
+		debug("get '%.*s' -> '%.*s'", (int)lvar, var, (int)v->lval, v->val);
+		if ((msg = sshbuf_new()) == NULL)
+			fatal_f("sshbuf_new failed");
+		if ((r = sshbuf_put_u8(msg, SSH_AGENT_GET_VARIABLE_ANSWER)) != 0 ||
+				(r = sshbuf_put_string(msg, v->val, v->lval)) != 0 ||
+				(r = sshbuf_put_u32(e->output, sshbuf_len(msg))) != 0 ||
+				(r = sshbuf_putb(e->output, msg)) != 0)
+			fatal_fr(r, "compose");
+		sshbuf_free(msg);
+	} else {
+		debug("variable '%.*s' not found", (int)lvar, var);
+		send_return_code(e, SSH_AGENT_NO_VARIABLE);
+	}
+	free(var);
+}
+
+/* send list of variables */
+static void
+process_list_variables(SocketEntry *e, char full)
+{
+	struct sshbuf *msg, *msg2;
+	int r;
+	char *prefix = NULL;
+	size_t lprefix = 0, nret = 0;
+	Variable *v;
+
+	if ((r = sshbuf_get_string(e->request, (u_char**)&prefix, &lprefix)) != 0)
+		lprefix = 0;
+	if (lprefix > 0)
+		debug("list variables starting with '%.*s'", (int)lprefix, prefix);
+	else
+		debug("list all variables");
+	if ((msg = sshbuf_new()) == NULL)
+		fatal_f("sshbuf_new failed");
+	TAILQ_FOREACH(v, &vartable.varlist, next) {
+		if (lprefix == 0 || (v->lvar >= lprefix && 0 == memcmp (v->var, prefix, lprefix))) {
+			if (full) debug("  -> '%.*s' = '%.*s'", (int)v->lvar, v->var, (int)v->lval, v->val);
+			else      debug("  -> '%.*s'",          (int)v->lvar, v->var);
+			if ((r = sshbuf_put_string(msg, v->var, v->lvar)) != 0 ||
+					(r = full ? sshbuf_put_string(msg, v->val, v->lval) : 0) != 0)
+				fatal_fr(r, "compose");
+			nret++;
+		}
+	}
+  free(prefix);
+	if ((msg2 = sshbuf_new()) == NULL)
+		fatal_f("sshbuf_new failed");
+	if ((r = sshbuf_put_u8(msg2, full ? SSH_AGENT_VARIABLES_ANSWER : SSH_AGENT_VARIABLE_NAMES_ANSWER)) != 0 ||
+	    (r = sshbuf_put_u32(msg2, nret)) != 0 ||
+	    (r = sshbuf_put_u32(e->output, sshbuf_len(msg)+sshbuf_len(msg2))) != 0 ||
+	    (r = sshbuf_putb(e->output, msg2)) != 0 ||
+	    (r = sshbuf_putb(e->output, msg)) != 0)
+		fatal_fr(r, "compose");
+	sshbuf_free(msg2);
+	sshbuf_free(msg);
+}
+
+static void
+no_variables(SocketEntry *e, size_t type)
+{
+	struct sshbuf *msg;
+	int r;
+
+	if ((msg = sshbuf_new()) == NULL)
+		fatal_f("sshbuf_new failed");
+	if ((r = sshbuf_put_u8(msg, (type == SSH_AGENTC_LIST_VARIABLES) ? SSH_AGENT_VARIABLES_ANSWER : SSH_AGENT_VARIABLE_NAMES_ANSWER)) != 0 ||
+	    (r = sshbuf_put_u32(msg, 0)) != 0 ||
+	    (r = sshbuf_put_u32(e->output, sshbuf_len(msg))) != 0 ||
+	    (r = sshbuf_put(e->output, sshbuf_ptr(msg), sshbuf_len(msg))) != 0)
+		fatal_fr(r, "compose");
+	sshbuf_free(msg);
+}
+
+/* shared */
+static void
+process_remove_variable(SocketEntry *e)
+{
+	size_t lvar = 0;
+	char *var = NULL;
+	Variable *v;
+	int r, ret;
+
+	if ((r = sshbuf_get_string(e->request, (u_char**)&var, &lvar)) != 0) {
+		error_fr(r, "parse");
+		send_return_code(e, SSH_AGENT_FAILURE);
+		return;
+	}
+	if ((v = lookup_variable(var, lvar))) {
+		debug("delete variable '%.*s' with value '%.*s'", (int)v->lvar, v->var, (int)v->lval, v->val);
+		if (vartable.nentries < 1)
+			fatal_f("internal error: vartable.nentries %d", vartable.nentries);
+		TAILQ_REMOVE(&vartable.varlist, v, next);
+		free_variable (v);
+		vartable.nentries--;
+		ret = SSH_AGENT_SUCCESS;
+	} else
+		ret = SSH_AGENT_NO_VARIABLE;
+	free (var);
+	send_return_code(e, ret);
+}
+
+static void
+process_remove_all_variables(SocketEntry *e)
+{
+	char *prefix = NULL;
+	size_t lprefix = 0, ndel = 0;
+	Variable *v, *last = NULL;
+	int r;
+
+	if ((r = sshbuf_get_string(e->request, (u_char**)&prefix, &lprefix)) != 0)
+		lprefix = 0;
+	TAILQ_FOREACH(v, &vartable.varlist, next) {
+		if (last) {   /* don't remove variable until we've moved past it */
+			TAILQ_REMOVE(&vartable.varlist, last, next);
+			free_variable (last);
+			last = NULL;
+		}
+		if (lprefix == 0 || (v->lvar >= lprefix && 0 == memcmp (v->var, prefix, lprefix))) {
+			debug("delete variable '%.*s' with value '%.*s'", (int)v->lvar, v->var, (int)v->lval, v->val);
+			vartable.nentries--;
+			ndel++;
+			last = v;
+		}
+	}
+	if (last) {
+		TAILQ_REMOVE(&vartable.varlist, last, next);
+		free_variable (last);
+	}
+	free(prefix);
+
+	/* Send success. */
+	send_return_code(e, ndel ? SSH_AGENT_SUCCESS : SSH_AGENT_NO_VARIABLE);
+}
+
+/* dispatch incoming messages */
+
 static void
 process_extension(SocketEntry *e)
 {
@@ -1653,6 +1890,10 @@ process_message(u_int socknum)
 			/* send empty lists */
 			no_identities(e);
 			break;
+		case SSH_AGENTC_LIST_VARIABLE_NAMES:
+		case SSH_AGENTC_LIST_VARIABLES:
+			no_variables(e, type);
+			break;
 		default:
 			/* send a fail message for all other request types */
 			send_status(e, 0);
@@ -1697,6 +1938,24 @@ process_message(u_int socknum)
 	case SSH_AGENTC_EXTENSION:
 		process_extension(e);
 		break;
+	case SSH_AGENTC_SET_VARIABLE:
+		process_set_variable(e);
+		break;
+	case SSH_AGENTC_GET_VARIABLE:
+		process_get_variable(e);
+		break;
+	case SSH_AGENTC_LIST_VARIABLE_NAMES:
+		process_list_variables(e, 0);
+		break;
+	case SSH_AGENTC_LIST_VARIABLES:
+		process_list_variables(e, 1);
+		break;
+	case SSH_AGENTC_REMOVE_VARIABLE:
+		process_remove_variable(e);
+		break;
+	case SSH_AGENTC_REMOVE_ALL_VARIABLES:
+		process_remove_all_variables(e);
+		break;
 	default:
 		/* Unknown message.  Respond with failure. */
 		error("Unknown message %d", type);
@@ -2261,7 +2520,9 @@ skip:
 	new_socket(AUTH_SOCKET, sock);
 	if (ac > 0)
 		parent_alive_interval = 10;
+
 	idtab_init();
+	vartab_init();
 	ssh_signal(SIGPIPE, SIG_IGN);
 	ssh_signal(SIGINT, (d_flag | D_flag) ? cleanup_handler : SIG_IGN);
 	ssh_signal(SIGHUP, cleanup_handler);
diff --git a/ssh-store.c b/ssh-store.c
new file mode 100644
index 000000000..112a68125
--- /dev/null
+++ b/ssh-store.c
@@ -0,0 +1,256 @@
+/* $OpenBSD: ssh-store.c,v 1.89 2006/08/03 03:34:42 deraadt Exp $ */
+/*
+ * ssh-store.c by Tim Adye <T.J.Adye@rl.ac.uk>, based on ssh-add.c.
+ *
+ * ssh-add.c:-
+ * Author: Tatu Ylonen <ylo@cs.hut.fi>
+ * Copyright (c) 1995 Tatu Ylonen <ylo@cs.hut.fi>, Espoo, Finland
+ *                    All rights reserved
+ * Adds an identity to the authentication server, or removes an identity.
+ *
+ * As far as I am concerned, the code I have written for this software
+ * can be used freely for any purpose.  Any derived versions of this
+ * software must be clearly marked as such, and if the derived work is
+ * incompatible with the protocol description in the RFC file, it must be
+ * called by a name other than "ssh" or "Secure Shell".
+ *
+ * SSH2 implementation,
+ * Copyright (c) 2000, 2001 Markus Friedl.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
+ * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
+ * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
+ * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
+ * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
+ * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
+ * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+
+#include "includes.h"
+
+#include <sys/types.h>
+#include <sys/stat.h>
+
+#include <openssl/evp.h>
+
+#include <fcntl.h>
+#include <pwd.h>
+#include <stdarg.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <unistd.h>
+
+#include "xmalloc.h"
+#include "ssh.h"
+#include "log.h"
+#include "sshkey.h"
+#include "sshbuf.h"
+#include "authfd.h"
+#include "authfile.h"
+#include "pathnames.h"
+#include "misc.h"
+#include "ssherr.h"
+#include "digest.h"
+
+/* argv0 */
+extern char *__progname;
+#define CHUNK 1024
+
+int
+set_from_file(int agent_fd, const char *var, size_t lvar, const char *file)
+{
+	FILE *f;
+	char *val = NULL;
+	size_t lval = 0;
+	size_t n;
+	int ret;
+
+	if (file && 0 != strcmp (file, "-")) {
+		f = fopen (file, "r");
+		if (!f) {
+			fprintf (stderr, "%s: could not open %s\n", __progname, file);
+			return 3;
+		}
+	} else {
+		f = stdin;
+	}
+	lval = 0;
+	do {
+		val= xreallocarray (val, lval+CHUNK, 1);
+		n = fread (val+lval, 1, CHUNK, f);
+		lval += n;
+	} while (n == CHUNK);
+	ret = ssh_set_variable (agent_fd, var, lvar, val, lval);
+	free (val);
+	return ret;
+}
+
+static int
+print_variable(int agent_fd, const char *var, size_t lvar)
+{
+	int ret;
+	char *val = NULL;
+	size_t lval = 0;
+
+	ret = ssh_get_variable(agent_fd, var, lvar, &val, &lval);
+	if (ret == 0 && val) {
+		fwrite (val, 1, lval, stdout);
+		free(val);
+	}
+	return ret;
+}
+
+static int
+list_variables(int agent_fd, const char* prefix, size_t lprefix, char full)
+{
+	char *var = NULL, *val = NULL;
+	size_t lvar = 0, lval = 0;
+	int r, nvars = 0;
+	struct sshbuf *buf = NULL;
+	u_int32_t howmany = 0;
+
+	for (r = ssh_get_first_variable(agent_fd, prefix, lprefix, full, &var, &lvar, &val, &lval, &buf, &howmany);
+	     r == 0;
+	     r = ssh_get_next_variable(agent_fd, full, &var, &lvar, &val, &lval, &buf, &howmany)) {
+		fwrite (var, 1, lvar, stdout);
+		if (full && val) {
+			putchar (' ');
+			fwrite (val, 1, lval, stdout);
+			if (!(lval > 0 && val[lval-1] == '\n')) putchar ('\n');
+		} else {
+			putchar ('\n');
+		}
+		free(var);
+		var = NULL;
+		if (val) free(val);
+		val = NULL;
+		nvars++;
+	}
+	if (r != SSH_AGENT_NO_VARIABLE) return r;
+	return (nvars==0 ? 1 : 0);
+}
+
+static void
+usage(void)
+{
+	fprintf(stderr, "Usage: %s [options] variable [value]\n", __progname);
+	fprintf(stderr, "Options:\n");
+	fprintf(stderr, "  -s          Set variable (default if value specified).\n");
+	fprintf(stderr, "  -f          Set value from a file (specified as second argument, or else stdin).\n");
+	fprintf(stderr, "  -g          Get variable value (default if value not specified).\n");
+	fprintf(stderr, "  -l          List stored variables.\n");
+	fprintf(stderr, "  -L          List stored variables and their values (may include binary values)\n");
+	fprintf(stderr, "  -d          Delete stored value.\n");
+	fprintf(stderr, "  -D          Delete all stored values.\n");
+}
+
+int
+main(int argc, char **argv)
+{
+	extern int optind;
+	int agent_fd;
+	int r, ch, set = 0, get = 0, list = 0, delete = 0, ret = 0;
+
+	/* Ensure that fds 0, 1 and 2 are open or directed to /dev/null */
+	sanitise_stdfd();
+
+	__progname = ssh_get_progname(argv[0]);
+
+	/* First, get a connection to the authentication agent. */
+	switch (r = ssh_get_authentication_socket(&agent_fd)) {
+	case 0:
+		break;
+	case SSH_ERR_AGENT_NOT_PRESENT:
+		fprintf(stderr, "Could not open a connection to your "
+		    "authentication agent.\n");
+		exit(2);
+	default:
+		fprintf(stderr, "Error connecting to agent: %s\n", ssh_err(r));
+		exit(2);
+	}
+	while ((ch = getopt(argc, argv, "hsfglLdD")) != -1) {
+		switch (ch) {
+		case 's':
+			set = 1;
+			break;
+		case 'f':
+			set = 2;
+			break;
+		case 'g':
+			get = 1;
+			break;
+		case 'l':
+			list = 1;
+			break;
+		case 'L':
+			list = 2;
+			break;
+		case 'd':
+			delete = 1;
+			break;
+		case 'D':
+			delete = 2;
+			break;
+		default:
+			usage();
+			ret = 2;
+			goto done;
+		}
+	}
+	argc -= optind;
+	argv += optind;
+
+	if ((set == 1 && argc != 2) ||
+	    (set == 2 && (argc < 1 || argc > 2)) ||
+	    ((get || delete == 1) && argc != 1) ||
+	    ((list || delete == 2) && argc > 1) ||
+	    ((!!set)+(!!get)+(!!list)+(!!delete) > 1)) {
+		fprintf (stderr, "%s: bad options\n", __progname);
+		goto done;
+	}
+	if (!(set || get || list || delete)) {
+		if      (argc == 1) get = 1;
+		else if (argc == 2) set = 1;
+		else {
+			usage();
+			goto done;
+		}
+	}
+
+	if        (set == 2) {
+		ret = set_from_file    (agent_fd, argv[0], strlen(argv[0]), (argc >= 2 ? argv[1] : NULL));
+	} else if (set) {
+		ret = ssh_set_variable (agent_fd, argv[0], strlen(argv[0]), argv[1], strlen(argv[1]));
+	} else if (get) {
+		ret = print_variable   (agent_fd, argv[0], strlen(argv[0]));
+	} else if (list) {
+		if (argc >= 1) {
+			ret = list_variables      (agent_fd, argv[0], strlen(argv[0]), (list==2));
+		} else {
+			ret = list_variables      (agent_fd, "",      0,               (list==2));
+		}
+	} else if (delete) {
+		if (argc >= 1) {
+			ret = ssh_delete_variable (agent_fd, argv[0], strlen(argv[0]), (delete==2));
+		} else {
+			ret = ssh_delete_variable (agent_fd, "",      0,               (delete==2));
+		}
+	}
+	
+done:
+	ssh_close_authentication_socket(agent_fd);
+	return (ret >= 0 ? ret : 10);
+}
