name: $(BuildDefinitionName)-$(date:yyMM).$(date:dd)$(rev:rrr)
trigger:
  # Batch merge builds together while a merge build is running
  batch: true
  branches:
    include:
    - latestw_all
pr:
  branches:
    include:
    - latestw_all

stages:
- stage: Build
  displayName: Build Win32-OpenSSH
  jobs:
  - job: BuildPkg
    displayName: Build Package
    pool:
      name: PS-PowerShell-x64
      demands:
      - ImageOverride -equals PSMMS2022-OpenSSH-Secure

    steps:
    - pwsh: |
        # Compare LibreSSL versions in vcpkg.json and add-resource-file.patch
        $vcpkgObj = Get-Content "$(Build.SourcesDirectory)/contrib/win32/openssh/vcpkg.json" | ConvertFrom-Json
        $libresslVersionJson = $vcpkgObj | Select-Object -ExpandProperty overrides | Where-Object { $_.name -eq 'libressl' } | Select-Object -ExpandProperty version

        # resource file version needs to be trimmed (e.g. 4.0.0.0 to 4.0.0)
        $patchContent = Get-Content "$(Build.SourcesDirectory)/contrib/win32/openssh/vcpkg_overlay_ports/libressl/add-version-file.patch"
        $libresslVersionPatch = ($patchContent -join "`n" | Select-String -Pattern '"FileVersion",\s*"(\d+\.\d+\.\d+\.\d+)"' -AllMatches).Matches | ForEach-Object { $_.Groups[1].Value }
        $libresslVersionPatchParts = $libresslVersionPatch -split '\.'
        $libresslVersionPatchShort = ($libresslVersionPatchParts[0..2] -join '.')

        if ($libresslVersionJson -ne $libresslVersionPatchShort) {
          Write-Error "LibreSSL version mismatch: vcpkg.json has $libresslVersionJson, patch file has $libresslVersionPatch"
          exit 1
        } else {
          Write-Verbose -Verbose "LibreSSL versions match: $libresslVersionJson"
        }
      displayName: 'Verify version info'

    - pwsh: |-
        git clone https://github.com/microsoft/vcpkg
        cd vcpkg
        & ./bootstrap-vcpkg.bat
        & ./vcpkg.exe integrate install
      displayName: Install vcpkg

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        Invoke-AzDOBuild
      displayName: Build Win32-OpenSSH

    - pwsh: |
        $BuildOutPath = "$(Build.SourcesDirectory)/bin"
        $BuildOutx86Path = Join-Path -Path $BuildOutPath -ChildPath 'Win32/Release'
        Get-ChildItem -Path $BuildOutx86Path
        $BuildOutx64Path = Join-Path -Path $BuildOutPath -ChildPath 'x64/Release'
        Get-ChildItem -Path $BuildOutx64Path
      displayName: Capture build results

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        #
        # Copy build artifacts
        $BuildDestPath = "$(Build.SourcesDirectory)/Win32-OpenSSH"
        if (Test-Path -Path $BuildDestPath) {
          Remove-Item -Path $BuildDestPath -Recurse -Force -ErrorAction SilentlyContinue
        }
        $null = New-Item -ItemType Directory -Path $BuildDestPath -Force
        $BuildDestx86Path = Join-Path -Path $BuildDestPath -ChildPath 'x86/Release'
        Copy-BuildResults -BuildResultsPath $BuildDestx86Path -NativeHostArch x86 -Configuration Release
        $BuildDestX64Path = Join-Path -Path $BuildDestPath -ChildPath 'x64/Release'
        Copy-BuildResults -BuildResultsPath $BuildDestx64Path -NativeHostArch x64 -Configuration Release
        #
        # Upload build artifacts
        Write-Verbose -Verbose -Message "Uploading build artifacts"
        $artifactName = 'Win32-OpenSSH'
        Write-Host "##vso[artifact.upload containerfolder=$artifactName;artifactname=$artifactName;]$BuildDestPath"
        #
        # Copy unit tests
        $BuildOutPath = "$(Build.SourcesDirectory)/bin"
        $UnitTestDestPath = "$(Build.SourcesDirectory)/UnitTests"
        Copy-UnitTests -UnitTestsSrcDir $BuildOutPath -UnitTestsDestDir $UnitTestDestPath -NativeHostArch x86 -Configuration Release
        Copy-UnitTests -UnitTestsSrcDir $BuildOutPath -UnitTestsDestDir $UnitTestDestPath -NativeHostArch x64 -Configuration Release
        #
        # Upload unit test artifacts
        Write-Verbose -Verbose -Message "Uploading unit test artifacts"
        $artifactName = 'UnitTests'
        Write-Host "##vso[artifact.upload containerfolder=$artifactName;artifactname=$artifactName;]$UnitTestDestPath"
        #
        # Upload bash tests config.h file
        Write-Verbose -Verbose -Message "Uploading config.h file for bash tests"
        $artifactName = 'ConfigFile'
        $configFilePath = "$(Build.SourcesDirectory)/config.h"
        Write-Host "##vso[artifact.upload containerfolder=$artifactName;artifactname=$artifactName;]$configFilePath"
      displayName: Upload Win32-OpenSSH build artifacts

    - pwsh: |
        $logFileNames = @("OpenSSHReleasex64.log", "OpenSSHReleasex86.log")
        $uniqueLines = [System.Collections.Generic.HashSet[string]]::new()
        forEach ($logFile in $logFileNames) {
          $logFilePath = "$(Build.SourcesDirectory)/contrib/win32/openssh/$logFile"
          $logLines = Get-Content $logFilePath
          $buildSucceededIndex = $logLines.IndexOf("Build succeeded.")
          $linesToCheck = $logLines[($buildSucceededIndex + 1)..$logLines.Length]
          forEach ($line in $linesToCheck) {
            if ($line -match "warning C") {
              $uniqueLines.Add($line) | Out-Null
            }
          }
        }
        forEach ($uniqueLine in $uniqueLines) {
          Write-Output $uniqueLine
          Write-Host "##vso[task.logissue type=warning]$uniqueLine"
        }
      displayName: Surface Warnings from Build Logs

- stage: Test
  displayName: Test Win32-OpenSSH
  dependsOn: Build
  jobs:
  - job: TestPkgWin32OpenSSH
    pool:
      vmImage: windows-latest
    displayName: Win32-OpenSSH On Windows
    variables:
      testFilesDrivePath: '**'
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: 'Download build artifacts'
      inputs:
        buildType: current
        downloadType: single
        artifactName: Win32-OpenSSH
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: DownloadBuildArtifacts@0
      displayName: 'Download unit test artifacts'
      inputs:
        buildType: current
        downloadType: single
        artifactName: UnitTests
        downloadPath: '$(System.ArtifactsDirectory)'

    - task: DownloadBuildArtifacts@0
      displayName: 'Download bash test config file artifact'
      inputs:
        buildType: current
        downloadType: single
        artifactName: ConfigFile
        downloadPath: '$(System.ArtifactsDirectory)'

    - pwsh: |
        $artifactDir = "$(System.ArtifactsDirectory)"
        Write-Verbose -Verbose -Message "Artifacts directory: $artifactDir"
        Get-ChildItem -Path $artifactDir -Recurse
      displayName: Capture downloaded artifact directory

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        Install-OpenSSH -SourceDir "$(System.ArtifactsDirectory)/Win32-OpenSSH/x64/Release" -OpenSSHDir "$env:SystemDrive/OpenSSH" -Verbose
      displayName: Install Win32-OpenSSH

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        Install-UnitTests -SourceDir "$(System.ArtifactsDirectory)/UnitTests/x64/Release" -OpenSSHDir "$env:SystemDrive/OpenSSH" -Verbose
      displayName: Install Unit Tests

    - pwsh: |
        $configFileSrc = "$(System.ArtifactsDirectory)/ConfigFile/config.h"
        $configFileDest = "$(Build.SourcesDirectory)"
        Write-Verbose -Verbose -Message "Copying config file from: ${configFileSrc} to: ${configFileDest}"
        Copy-Item -Path $configFileSrc -Dest $configFileDest -Force
      displayName: Copy config file artifact for bash tests

    - pwsh: |
        $sourceDir = "$(Build.SourcesDirectory)"
        Write-Verbose -Verbose -Message "Source repo directory: $sourceDir"
        Get-ChildItem -Path $sourceDir
      displayName: Capture source repo directory for test

    - pwsh: |
        $installedOpenSSHDir = "$env:SystemDrive/OpenSSH"
        Write-Verbose -Verbose -Message "Installed OpenSSH directory: $installedOpenSSHDir"
        Get-ChildItem -Path $installedOpenSSHDir -Recurse
      displayName: Capture installed OpenSSH directory

    - pwsh: |
        # Run OpenSSH tests
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        Invoke-OpenSSHTests -OpenSSHBinPath "$env:SystemDrive/OpenSSH"
      displayName: Run tests

    - pwsh: |
        Write-Host "##vso[task.setvariable variable=testFilesDrivePath;]$env:SystemDrive"
      displayName: Set variable

    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'NUnit'
        testResultsFiles: '$(testFilesDrivePath)/OpenSSHTests/*.xml'
        failTaskOnFailedTests: true
      condition: always()

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        #
        # Copy test results to results directory
        $ResultsDirectory = "$(Build.SourcesDirectory)/Win32OpenSSHTestResults"
        Copy-OpenSSHTestResults -ResultsPath $ResultsDirectory
        #
        # Upload test results artifact
        if (Test-Path -Path $ResultsDirectory)
        {
          $artifactName = 'Win32-OpenSSH-TestResults'
          Write-Host "##vso[artifact.upload containerfolder=$artifactName;artifactname=$artifactName;]$ResultsDirectory"
        }
      displayName: Upload test results
      condition: always()

    - pwsh: |
        Import-Module -Name "$(Build.SourcesDirectory)/contrib/win32/openssh/AzDOBuildTools" -Force
        Clear-TestEnvironmentSetup
      displayName: Clean up OpenSSH test environment
      condition: always()
